{% extends 'base.html' %}
{% block content %}
<style>
.test-container {
  max-width: 1200px;
  margin: 0 auto;
}

.test-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  color: white;
}

.test-header h2 {
  margin: 0 0 8px 0;
  font-size: 24px;
}

.test-header p {
  margin: 0;
  opacity: 0.9;
}

.test-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

@media (max-width: 900px) {
  .test-grid {
    grid-template-columns: 1fr;
  }
}

.test-card {
  background: #fff;
  border-radius: 16px;
  padding: 24px;
  border: 1px solid var(--border);
}

.test-card h3 {
  margin: 0 0 16px 0;
  font-size: 18px;
  color: #333;
}

.test-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-height: 400px;
  overflow-y: auto;
}

.test-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: #f8f9fa;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.test-option:hover {
  background: #e9ecef;
}

.test-option.selected {
  background: #e3f2fd;
  border-color: #1da1f2;
}

.test-option input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.test-option .icon {
  font-size: 24px;
}

.test-option .info {
  flex: 1;
}

.test-option .info .name {
  font-weight: 600;
  color: #333;
}

.test-option .info .desc {
  font-size: 12px;
  color: #666;
}

.config-section {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #eee;
}

.config-section label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
}

.config-section select,
.config-section input {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  margin-bottom: 12px;
}

.btn-test {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 16px;
}

.btn-test:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.btn-test:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-select-all {
  padding: 8px 16px;
  background: #e9ecef;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  margin-bottom: 12px;
}

.btn-select-all:hover {
  background: #dee2e6;
}

.results-card {
  background: #fff;
  border-radius: 16px;
  padding: 24px;
  border: 1px solid var(--border);
}

.results-card h3 {
  margin: 0 0 16px 0;
  font-size: 18px;
  color: #333;
}

.results-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-height: 500px;
  overflow-y: auto;
}

.result-item {
  padding: 16px;
  border-radius: 12px;
  border: 1px solid #eee;
}

.result-item.success {
  background: #d4edda;
  border-color: #c3e6cb;
}

.result-item.error {
  background: #f8d7da;
  border-color: #f5c6cb;
}

.result-item.pending {
  background: #fff3cd;
  border-color: #ffeeba;
}

.result-item.running {
  background: #cce5ff;
  border-color: #b8daff;
}

.result-item .header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.result-item .header .icon {
  font-size: 20px;
}

.result-item .header .name {
  font-weight: 600;
  flex: 1;
}

.result-item .header .status {
  font-size: 12px;
  padding: 4px 12px;
  border-radius: 20px;
  font-weight: 600;
}

.result-item.success .status {
  background: #28a745;
  color: white;
}

.result-item.error .status {
  background: #dc3545;
  color: white;
}

.result-item.pending .status {
  background: #ffc107;
  color: #333;
}

.result-item.running .status {
  background: #007bff;
  color: white;
}

.result-item .message {
  font-size: 13px;
  color: #555;
}

.result-item .time {
  font-size: 11px;
  color: #888;
  margin-top: 8px;
}

.summary-bar {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
}

.summary-item {
  text-align: center;
  flex: 1;
}

.summary-item .count {
  font-size: 28px;
  font-weight: 700;
}

.summary-item .label {
  font-size: 12px;
  color: #666;
}

.summary-item.total .count { color: #333; }
.summary-item.success .count { color: #28a745; }
.summary-item.error .count { color: #dc3545; }

.empty-results {
  text-align: center;
  padding: 60px 20px;
  color: #888;
}

.empty-results .icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  margin-left: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.progress-bar {
  height: 8px;
  background: #e9ecef;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 16px;
}

.progress-bar .fill {
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s;
}
</style>

<div class="test-container">
  <div class="test-header">
    <h2>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
    <p>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±Ù‡Ø§ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
  </div>

  <div class="test-grid">
    <div class="test-card">
      <h3>ğŸ“‹ Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
      
      <button type="button" class="btn-select-all" onclick="toggleSelectAll()">ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
      
      <div class="test-options" id="testOptions">
        <label class="test-option" data-test="health">
          <input type="checkbox" name="tests" value="health" checked>
          <span class="icon">ğŸ’š</span>
          <div class="info">
            <div class="name">ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø®Ø§Ø¯Ù…</div>
            <div class="desc">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</div>
          </div>
        </label>

        <label class="test-option" data-test="cookies">
          <input type="checkbox" name="tests" value="cookies" checked>
          <span class="icon">ğŸª</span>
          <div class="info">
            <div class="name">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙˆÙƒÙŠØ²</div>
            <div class="desc">Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</div>
          </div>
        </label>

        <label class="test-option" data-test="stats">
          <input type="checkbox" name="tests" value="stats" checked>
          <span class="icon">ğŸ“Š</span>
          <div class="info">
            <div class="name">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
            <div class="desc">Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</div>
          </div>
        </label>

        <label class="test-option" data-test="logs">
          <input type="checkbox" name="tests" value="logs" checked>
          <span class="icon">ğŸ“</span>
          <div class="info">
            <div class="name">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
            <div class="desc">Ù‚Ø±Ø§Ø¡Ø© Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
          </div>
        </label>

        <label class="test-option" data-test="tweets">
          <input type="checkbox" name="tests" value="tweets" checked>
          <span class="icon">ğŸ“‹</span>
          <div class="info">
            <div class="name">Ø§Ù„ØªØºØ±ÙŠØ¯Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</div>
            <div class="desc">Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØºØ±ÙŠØ¯Ø§Øª</div>
          </div>
        </label>

        <label class="test-option" data-test="post">
          <input type="checkbox" name="tests" value="post">
          <span class="icon">ğŸ“</span>
          <div class="info">
            <div class="name">Ù†Ø´Ø± ØªØºØ±ÙŠØ¯Ø©</div>
            <div class="desc">Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø´Ø± ØªØºØ±ÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
          </div>
        </label>

        <label class="test-option" data-test="like">
          <input type="checkbox" name="tests" value="like">
          <span class="icon">â¤ï¸</span>
          <div class="info">
            <div class="name">Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨</div>
            <div class="desc">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨ØªØºØ±ÙŠØ¯Ø©</div>
          </div>
        </label>

        <label class="test-option" data-test="repost">
          <input type="checkbox" name="tests" value="repost">
          <span class="icon">ğŸ”</span>
          <div class="info">
            <div class="name">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø±</div>
            <div class="desc">Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø± ØªØºØ±ÙŠØ¯Ø©</div>
          </div>
        </label>

        <label class="test-option" data-test="bookmark">
          <input type="checkbox" name="tests" value="bookmark">
          <span class="icon">ğŸ”–</span>
          <div class="info">
            <div class="name">Ø§Ù„Ø¨ÙˆÙƒ Ù…Ø§Ø±Ùƒ</div>
            <div class="desc">Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© ØªØºØ±ÙŠØ¯Ø© Ù„Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©</div>
          </div>
        </label>

        <label class="test-option" data-test="follow">
          <input type="checkbox" name="tests" value="follow">
          <span class="icon">â•</span>
          <div class="info">
            <div class="name">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</div>
            <div class="desc">Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø³Ø§Ø¨</div>
          </div>
        </label>
      </div>

      <div class="config-section">
        <label>Ø§Ù„Ø­Ø³Ø§Ø¨ (Cookie)</label>
        <select id="cookieLabel">
          <option value="">-- Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨ --</option>
          {% for c in cookies %}
          <option value="{{ c.label }}">{{ c.label }}</option>
          {% endfor %}
        </select>

        <label>Ø±Ø§Ø¨Ø· ØªØºØ±ÙŠØ¯Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="url" id="testTweetUrl" placeholder="https://x.com/user/status/...">

        <label>Ù†Øµ ØªØºØ±ÙŠØ¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
        <input type="text" id="testText" value="Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† X Suite API ğŸ§ª" placeholder="Ù†Øµ Ø§Ù„ØªØºØ±ÙŠØ¯Ø©">

        <label>Ø±Ø§Ø¨Ø· Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="url" id="testProfileUrl" placeholder="https://x.com/username">
      </div>

      <button type="button" class="btn-test" id="btnRunTests" onclick="runTests()">
        ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
      </button>
    </div>

    <div class="results-card">
      <h3>ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
      
      <div class="summary-bar" id="summaryBar" style="display: none;">
        <div class="summary-item total">
          <div class="count" id="totalCount">0</div>
          <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
        </div>
        <div class="summary-item success">
          <div class="count" id="successCount">0</div>
          <div class="label">Ù†Ø§Ø¬Ø­</div>
        </div>
        <div class="summary-item error">
          <div class="count" id="errorCount">0</div>
          <div class="label">ÙØ§Ø´Ù„</div>
        </div>
      </div>

      <div class="progress-bar" id="progressBar" style="display: none;">
        <div class="fill" id="progressFill" style="width: 0%"></div>
      </div>

      <div class="results-list" id="resultsList">
        <div class="empty-results">
          <div class="icon">ğŸ§ª</div>
          <div>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API_TOKEN = "{{ api_token }}";
const testNames = {
  health: "ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø®Ø§Ø¯Ù…",
  cookies: "Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙˆÙƒÙŠØ²",
  stats: "Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª",
  logs: "Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª",
  tweets: "Ø§Ù„ØªØºØ±ÙŠØ¯Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©",
  post: "Ù†Ø´Ø± ØªØºØ±ÙŠØ¯Ø©",
  like: "Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨",
  repost: "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø±",
  bookmark: "Ø§Ù„Ø¨ÙˆÙƒ Ù…Ø§Ø±Ùƒ",
  follow: "Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"
};

const testIcons = {
  health: "ğŸ’š",
  cookies: "ğŸª",
  stats: "ğŸ“Š",
  logs: "ğŸ“",
  tweets: "ğŸ“‹",
  post: "ğŸ“",
  like: "â¤ï¸",
  repost: "ğŸ”",
  bookmark: "ğŸ”–",
  follow: "â•"
};

// Update option styling on checkbox change
document.querySelectorAll('.test-option input').forEach(cb => {
  cb.addEventListener('change', function() {
    this.closest('.test-option').classList.toggle('selected', this.checked);
  });
  // Initial state
  if (cb.checked) cb.closest('.test-option').classList.add('selected');
});

function toggleSelectAll() {
  const checkboxes = document.querySelectorAll('.test-option input');
  const allChecked = Array.from(checkboxes).every(cb => cb.checked);
  checkboxes.forEach(cb => {
    cb.checked = !allChecked;
    cb.closest('.test-option').classList.toggle('selected', cb.checked);
  });
}

function getSelectedTests() {
  return Array.from(document.querySelectorAll('.test-option input:checked')).map(cb => cb.value);
}

function updateResults(results) {
  const list = document.getElementById('resultsList');
  const summary = document.getElementById('summaryBar');
  
  if (results.length === 0) {
    list.innerHTML = `<div class="empty-results"><div class="icon">ğŸ§ª</div><div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div></div>`;
    summary.style.display = 'none';
    return;
  }

  summary.style.display = 'flex';
  
  const total = results.length;
  const success = results.filter(r => r.status === 'success').length;
  const error = results.filter(r => r.status === 'error').length;
  
  document.getElementById('totalCount').textContent = total;
  document.getElementById('successCount').textContent = success;
  document.getElementById('errorCount').textContent = error;

  list.innerHTML = results.map(r => `
    <div class="result-item ${r.status}">
      <div class="header">
        <span class="icon">${testIcons[r.test] || 'ğŸ”¹'}</span>
        <span class="name">${testNames[r.test] || r.test}</span>
        <span class="status">${r.status === 'success' ? 'Ù†Ø§Ø¬Ø­ âœ…' : r.status === 'error' ? 'ÙØ§Ø´Ù„ âŒ' : r.status === 'running' ? 'Ø¬Ø§Ø±ÙŠ...' : 'Ø§Ù†ØªØ¸Ø§Ø±'}</span>
      </div>
      <div class="message">${r.message || ''}</div>
      <div class="time">${r.time || ''}</div>
    </div>
  `).join('');
}

async function runTests() {
  const tests = getSelectedTests();
  if (tests.length === 0) {
    alert('Ø§Ø®ØªØ± Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    return;
  }

  const cookieLabel = document.getElementById('cookieLabel').value;
  const tweetUrl = document.getElementById('testTweetUrl').value;
  const testText = document.getElementById('testText').value;
  const profileUrl = document.getElementById('testProfileUrl').value;

  // Check if action tests need cookie
  const actionTests = ['post', 'like', 'repost', 'bookmark', 'follow'];
  const needsCookie = tests.some(t => actionTests.includes(t));
  if (needsCookie && !cookieLabel) {
    alert('Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨ (Cookie) Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„');
    return;
  }

  const btn = document.getElementById('btnRunTests');
  btn.disabled = true;
  btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±... <span class="spinner"></span>';

  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  progressBar.style.display = 'block';

  const results = [];
  
  for (let i = 0; i < tests.length; i++) {
    const test = tests[i];
    const progress = ((i + 1) / tests.length) * 100;
    progressFill.style.width = progress + '%';

    results.push({
      test: test,
      status: 'running',
      message: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...',
      time: new Date().toLocaleTimeString('ar-SA')
    });
    updateResults(results);

    try {
      const result = await runSingleTest(test, cookieLabel, tweetUrl, testText, profileUrl);
      results[results.length - 1] = {
        test: test,
        status: result.success ? 'success' : 'error',
        message: result.message || result.error || JSON.stringify(result),
        time: new Date().toLocaleTimeString('ar-SA')
      };
    } catch (err) {
      results[results.length - 1] = {
        test: test,
        status: 'error',
        message: err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹',
        time: new Date().toLocaleTimeString('ar-SA')
      };
    }
    updateResults(results);
  }

  btn.disabled = false;
  btn.innerHTML = 'ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
}

async function runSingleTest(test, cookieLabel, tweetUrl, testText, profileUrl) {
  const headers = {
    'Authorization': `Bearer ${API_TOKEN}`,
    'Content-Type': 'application/json'
  };

  let url, method = 'GET', body = null;

  switch (test) {
    case 'health':
      url = '/api/health';
      break;
    case 'cookies':
      url = '/api/cookies';
      break;
    case 'stats':
      url = '/api/stats';
      break;
    case 'logs':
      url = '/api/logs?limit=10';
      break;
    case 'tweets':
      url = '/api/tweets?limit=10';
      break;
    case 'post':
      url = '/api/post';
      method = 'POST';
      body = JSON.stringify({
        cookie_label: cookieLabel,
        text: testText || 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† X Suite ğŸ§ª',
        headless: true
      });
      break;
    case 'like':
      if (!tweetUrl) return { success: false, error: 'Ø±Ø§Ø¨Ø· Ø§Ù„ØªØºØ±ÙŠØ¯Ø© Ù…Ø·Ù„ÙˆØ¨' };
      url = '/api/like';
      method = 'POST';
      body = JSON.stringify({
        cookie_label: cookieLabel,
        tweet_url: tweetUrl,
        headless: true
      });
      break;
    case 'repost':
      if (!tweetUrl) return { success: false, error: 'Ø±Ø§Ø¨Ø· Ø§Ù„ØªØºØ±ÙŠØ¯Ø© Ù…Ø·Ù„ÙˆØ¨' };
      url = '/api/repost';
      method = 'POST';
      body = JSON.stringify({
        cookie_label: cookieLabel,
        tweet_url: tweetUrl,
        headless: true
      });
      break;
    case 'bookmark':
      if (!tweetUrl) return { success: false, error: 'Ø±Ø§Ø¨Ø· Ø§Ù„ØªØºØ±ÙŠØ¯Ø© Ù…Ø·Ù„ÙˆØ¨' };
      url = '/api/bookmark';
      method = 'POST';
      body = JSON.stringify({
        cookie_label: cookieLabel,
        tweet_url: tweetUrl,
        headless: true
      });
      break;
    case 'follow':
      if (!profileUrl) return { success: false, error: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨' };
      url = '/api/follow';
      method = 'POST';
      body = JSON.stringify({
        cookie_label: cookieLabel,
        profile_url: profileUrl,
        headless: true
      });
      break;
    default:
      return { success: false, error: 'Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' };
  }

  const options = { method, headers };
  if (body) options.body = body;

  const response = await fetch(url, options);
  const data = await response.json();
  
  if (test === 'health') {
    return { success: data.status === 'healthy', message: `Ø§Ù„Ø­Ø§Ù„Ø©: ${data.status}` };
  }
  
  return data;
}
</script>
{% endblock %}
